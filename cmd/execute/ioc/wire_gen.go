// Code generated by Wire. DO NOT EDIT.

//go:generate go run -mod=mod github.com/google/wire/cmd/wire
//go:build !wireinject
// +build !wireinject

package ioc

import (
	"fmt"
	"github.com/Duke1616/ework-runner/api/proto/gen/executor/v1"
	"github.com/Duke1616/ework-runner/api/proto/gen/reporter/v1"
	grpc3 "github.com/Duke1616/ework-runner/internal/grpc"
	"github.com/Duke1616/ework-runner/ioc"
	grpc2 "github.com/Duke1616/ework-runner/pkg/grpc"
	"github.com/Duke1616/ework-runner/pkg/grpc/registry"
	"github.com/Duke1616/ework-runner/pkg/grpc/registry/etcd"
	"github.com/google/wire"
	"github.com/spf13/viper"
	"go.etcd.io/etcd/client/v3"
	"google.golang.org/grpc"
	"google.golang.org/grpc/credentials/insecure"
)

// Injectors from wire.go:

func InitExecuteApp() *ExecuteApp {
	client := ioc.InitEtcdClient()
	registry := InitRegistry(client)
	reporterServiceClient := initReporterServiceClient()
	server := InitExecutorGRPCServer(registry, reporterServiceClient)
	executeApp := &ExecuteApp{
		Server: server,
	}
	return executeApp
}

// wire.go:

var (
	BaseSet = wire.NewSet(ioc.InitEtcdClient, InitRegistry)

	grpcServerSet = wire.NewSet(
		InitExecutorGRPCServer,
	)

	grpcClientSet = wire.NewSet(
		initReporterServiceClient,
	)
)

// InitRegistry 初始化注册中心
func InitRegistry(client *clientv3.Client) registry.Registry {
	reg, err := etcd.NewRegistry(client)
	if err != nil {
		panic(err)
	}
	return reg
}

func initReporterServiceClient() reporterv1.ReporterServiceClient {

	target := fmt.Sprintf("%s:%d", "127.0.0.1", 9002)

	conn, err := grpc.NewClient(
		target, grpc.WithTransportCredentials(insecure.NewCredentials()),
	)

	if err != nil {
		panic(err)
	}
	return reporterv1.NewReporterServiceClient(conn)
}

// InitExecutorGRPCServer 初始化 Executor gRPC 服务器
func InitExecutorGRPCServer(reg registry.Registry, client reporterv1.ReporterServiceClient) *grpc2.Server {
	var cfg ServerConfig
	if err := viper.UnmarshalKey("server.executor.grpc", &cfg); err != nil {
		panic(err)
	}

	server := grpc2.NewServer(cfg.Id, cfg.Name, cfg.Addr(), reg)

	executor := grpc3.NewExecutor(client)
	executorv1.RegisterExecutorServiceServer(server.Server, executor)

	return server
}

type ServerConfig struct {
	Id   string `mapstructure:"id"`
	Name string `mapstructure:"name"`
	Host string `mapstructure:"host"`
	Port int    `mapstructure:"port"`
}

// Addr 返回服务器地址
func (c *ServerConfig) Addr() string {
	return fmt.Sprintf("%s:%d", c.Host, c.Port)
}

type ExecuteApp struct {
	Server *grpc2.Server
}
